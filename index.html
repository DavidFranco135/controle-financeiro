<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sítio Escola de Cura - Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
    <div id="auth-container" class="max-w-md mx-auto mt-20 bg-white p-8 rounded-2xl shadow-xl hidden">
        <h2 class="text-2xl font-bold text-green-800 mb-6 text-center">Acesso Restrito</h2>
        <input type="email" id="email" placeholder="E-mail" class="w-full px-4 py-2 border rounded-lg mb-4">
        <input type="password" id="password" placeholder="Senha" class="w-full px-4 py-2 border rounded-lg mb-6">
        <button onclick="fazerLogin()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">Entrar</button>
        <p id="auth-error" class="text-red-500 mt-4 text-sm text-center"></p>
    </div>

    <div id="app-container" class="hidden">
        <div id="root"></div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDIQw3v9C7FnRNf8_uuiqbx2NLvVErNke0",
            authDomain: "sitio-escola-de-cura.firebaseapp.com",
            projectId: "sitio-escola-de-cura"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let state = {
            transacoes: [],
            descricao: '', valor: '', tipo: 'entrada', categoria: '',
            data: new Date().toISOString().split('T')[0],
            mesSelecionado: new Date().toISOString().slice(0, 7)
        };

        // Gerenciamento de Autenticação
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                carregarDados();
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }
        });

        async function fazerLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (error) {
                document.getElementById('auth-error').innerText = "E-mail ou senha incorretos.";
            }
        }

        async function carregarDados() {
            const snap = await db.collection("financeiro").orderBy("data", "desc").get();
            state.transacoes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render();
        }

        // --- ABAIXO MANTÉM TODA A LÓGICA ORIGINAL QUE VOCÊ ENVIOU ---
        
        async function adicionarTransacao() {
            if (!state.descricao || !state.valor || !state.categoria) {
                alert('Preencha tudo!'); return;
            }
            await db.collection("financeiro").add({
                descricao: state.descricao,
                valor: parseFloat(state.valor),
                tipo: state.tipo,
                categoria: state.categoria,
                data: state.data
            });
            state.descricao = ''; state.valor = ''; 
            carregarDados();
        }

        async function removerTransacao(id) {
            if (confirm('Excluir?')) {
                await db.collection("financeiro").doc(id).delete();
                carregarDados();
            }
        }

        const formatarMoeda = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const obterMesAno = (ma) => {
            const [a, m] = ma.split('-');
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return `${meses[parseInt(m) - 1]} ${a}`;
        };

        function render() {
            const filtradas = state.transacoes.filter(t => t.data.startsWith(state.mesSelecionado));
            const entradas = filtradas.filter(t => t.tipo === 'entrada').reduce((acc, t) => acc + t.valor, 0);
            const saidas = filtradas.filter(t => t.tipo === 'saida').reduce((acc, t) => acc + t.valor, 0);
            const saldo = entradas - saidas;

            document.getElementById('root').innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-3xl font-bold text-green-800">Sítio Escola de Cura - Financeiro</h1>
                            <button onclick="auth.signOut()" class="text-sm text-gray-500 hover:text-red-500">Sair</button>
                        </div>
                        
                        <div class="grid md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-600 rounded-xl p-6 text-white">
                                <span class="text-green-100 text-sm">Entradas</span>
                                <div class="text-3xl font-bold">${formatarMoeda(entradas)}</div>
                            </div>
                            <div class="bg-red-600 rounded-xl p-6 text-white">
                                <span class="text-red-100 text-sm">Saídas</span>
                                <div class="text-3xl font-bold">${formatarMoeda(saidas)}</div>
                            </div>
                            <div class="bg-blue-600 rounded-xl p-6 text-white">
                                <span class="text-blue-100 text-sm">Saldo</span>
                                <div class="text-3xl font-bold">${formatarMoeda(saldo)}</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-6 mb-6">
                            <div class="grid md:grid-cols-2 gap-4">
                                <input type="text" placeholder="Descrição" oninput="state.descricao = this.value" class="border p-2 rounded">
                                <input type="number" placeholder="Valor" oninput="state.valor = this.value" class="border p-2 rounded">
                                <select onchange="state.tipo = this.value; render()" class="border p-2 rounded">
                                    <option value="entrada">Entrada</option>
                                    <option value="saida">Saída</option>
                                </select>
                                <select onchange="state.categoria = this.value" class="border p-2 rounded">
                                    <option value="">Categoria...</option>
                                    ${(state.tipo === 'entrada' ? ['Agendamento Cliente', 'Outros'] : ['Produtos Piscina', 'Gasolina Roçadeira', 'Contas', 'Manutenção', 'Alimentação', 'Outros']).map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                                <input type="date" value="${state.data}" oninput="state.data = this.value" class="border p-2 rounded">
                            </div>
                            <button onclick="adicionarTransacao()" class="w-full bg-green-600 text-white py-3 rounded mt-4">Adicionar</button>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-6">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="font-bold">Relatório: ${obterMesAno(state.mesSelecionado)}</h2>
                                <input type="month" value="${state.mesSelecionado}" onchange="state.mesSelecionado = this.value; render()" class="border p-2 rounded">
                             </div>
                             <div class="space-y-2">
                                ${filtradas.map(t => `
                                    <div class="bg-white p-3 border rounded flex justify-between items-center">
                                        <div>
                                            <div class="text-xs ${t.tipo === 'entrada' ? 'text-green-600' : 'text-red-600'}">${t.categoria}</div>
                                            <div class="font-bold">${t.descricao}</div>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <span class="font-bold">${formatarMoeda(t.valor)}</span>
                                            <button onclick="removerTransacao('${t.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                `).join('')}
                             </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
    </script>
</body>
</html>
